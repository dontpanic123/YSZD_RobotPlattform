<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœºå™¨äººç³»ç»Ÿè¯Šæ–­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .status.unknown { background: #fff3cd; color: #856404; }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        .refresh-btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– æœºå™¨äººç³»ç»Ÿè¯Šæ–­é¡µé¢</h1>
        
        <div class="card">
            <h2>ğŸ“¡ è¿æ¥çŠ¶æ€</h2>
            <p>WebSocketè¿æ¥: <span id="wsStatus" class="status unknown">æ£€æŸ¥ä¸­...</span></p>
            <p>ROS2æ¡¥æ¥: <span id="ros2Status" class="status unknown">æ£€æŸ¥ä¸­...</span></p>
            <p>é‡Œç¨‹è®¡æ•°æ®: <span id="odomStatus" class="status unknown">æ£€æŸ¥ä¸­...</span></p>
            <button class="refresh-btn" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
        </div>

        <div class="card">
            <h2>ğŸ“ æœºå™¨äººçŠ¶æ€</h2>
            <div class="data-display" id="robotData">
                ç­‰å¾…æ•°æ®...
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h2>
            <div class="data-display" id="systemInfo">
                åŠ è½½ä¸­...
            </div>
        </div>

        <div class="card">
            <h2>ğŸ” è°ƒè¯•ä¿¡æ¯</h2>
            <div class="data-display" id="debugInfo">
                ç­‰å¾…è¿æ¥...
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let lastOdomData = null;
        let debugMessages = [];

        function updateStatus() {
            // æ£€æŸ¥WebSocketè¿æ¥
            const wsStatus = document.getElementById('wsStatus');
            if (ws && ws.readyState === WebSocket.OPEN) {
                wsStatus.textContent = 'å·²è¿æ¥';
                wsStatus.className = 'status connected';
            } else {
                wsStatus.textContent = 'æœªè¿æ¥';
                wsStatus.className = 'status disconnected';
            }

            // æ›´æ–°æœºå™¨äººæ•°æ®
            const robotData = document.getElementById('robotData');
            if (lastOdomData) {
                const pos = lastOdomData.pose?.pose?.position || {};
                const vel = lastOdomData.twist?.twist || {};
                
                // åªæ˜¾ç¤ºX,Yçº¿é€Ÿåº¦å’ŒZè§’é€Ÿåº¦
                const angularZ = vel.angular?.z || 0;
                const angularZDeg = (angularZ * 180 / Math.PI).toFixed(1);
                
                robotData.textContent = `ä½ç½®: (${pos.x?.toFixed(2) || '--'}, ${pos.y?.toFixed(2) || '--'}, ${pos.z?.toFixed(2) || '--'})
çº¿é€Ÿåº¦: X=${vel.linear?.x?.toFixed(2) || '--'}, Y=${vel.linear?.y?.toFixed(2) || '--'}
è§’é€Ÿåº¦: Z=${angularZ.toFixed(2)}rad/${angularZDeg}Â°
æ—¶é—´: ${new Date().toLocaleTimeString()}`;
            } else {
                robotData.textContent = 'æœªæ”¶åˆ°é‡Œç¨‹è®¡æ•°æ®';
            }

            // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
            const systemInfo = document.getElementById('systemInfo');
            systemInfo.textContent = `ç”¨æˆ·ä»£ç†: ${navigator.userAgent}
å½“å‰æ—¶é—´: ${new Date().toLocaleString()}
é¡µé¢URL: ${window.location.href}
WebSocketçŠ¶æ€: ${ws ? ws.readyState : 'null'}`;

            // æ›´æ–°è°ƒè¯•ä¿¡æ¯
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.textContent = debugMessages.slice(-10).join('\n');
        }

        function connectWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:9090');
                
                ws.onopen = function() {
                    debugMessages.push(`[${new Date().toLocaleTimeString()}] WebSocketè¿æ¥å·²å»ºç«‹`);
                    updateStatus();
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'odom') {
                            lastOdomData = data;
                            const pos = data.pose?.pose?.position || {};
                            const vel = data.twist?.twist || {};
                            
                            // åªæ˜¾ç¤ºX,Yçº¿é€Ÿåº¦å’ŒZè§’é€Ÿåº¦
                            const angularZ = vel.angular?.z || 0;
                            const angularZDeg = (angularZ * 180 / Math.PI).toFixed(1);
                            
                            debugMessages.push(`[${new Date().toLocaleTimeString()}] æ”¶åˆ°é‡Œç¨‹è®¡æ•°æ®: ä½ç½®=(${pos.x?.toFixed(2)}, ${pos.y?.toFixed(2)}, ${pos.z?.toFixed(2)}) çº¿é€Ÿåº¦=(${vel.linear?.x?.toFixed(2)}, ${vel.linear?.y?.toFixed(2)}) è§’é€Ÿåº¦Z=${angularZ.toFixed(2)}rad/${angularZDeg}Â°`);
                        }
                        updateStatus();
                    } catch (e) {
                        debugMessages.push(`[${new Date().toLocaleTimeString()}] è§£ææ¶ˆæ¯å¤±è´¥: ${e.message}`);
                    }
                };

                ws.onclose = function() {
                    debugMessages.push(`[${new Date().toLocaleTimeString()}] WebSocketè¿æ¥å·²å…³é—­`);
                    updateStatus();
                };

                ws.onerror = function(error) {
                    debugMessages.push(`[${new Date().toLocaleTimeString()}] WebSocketé”™è¯¯: ${error}`);
                    updateStatus();
                };

            } catch (e) {
                debugMessages.push(`[${new Date().toLocaleTimeString()}] è¿æ¥WebSocketå¤±è´¥: ${e.message}`);
            }
        }

        function refreshStatus() {
            debugMessages.push(`[${new Date().toLocaleTimeString()}] æ‰‹åŠ¨åˆ·æ–°çŠ¶æ€`);
            if (ws) {
                ws.close();
            }
            connectWebSocket();
        }

        // é¡µé¢åŠ è½½æ—¶è¿æ¥
        window.onload = function() {
            connectWebSocket();
            setInterval(updateStatus, 1000);
        };
    </script>
</body>
</html>
